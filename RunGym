/**
 * Main application for the Gym Management System (menu-driven).
 */

import java.nio.file.Path;
import java.nio.file.Paths;
import java.time.LocalDate;
import java.time.LocalTime;
import java.util.Scanner;

/**
 * The RunGym class contains the main() entry point and menus.
 */
public class RunGym {
    private static final Path USERS_CSV = Paths.get("GymUsersData.csv");
    private static final Path SESSIONS_CSV = Paths.get("GymSessions.csv");
    private static final Path PLANS_CSV = Paths.get("GymPlans.csv");
    private static final Path LOG_FILE = Paths.get("gym_log.txt");

    private GymDataManager manager;
    private Log log;
    private Scanner scanner = new Scanner(System.in);

    public RunGym() {
        manager = new GymDataManager(USERS_CSV, SESSIONS_CSV, PLANS_CSV);
        log = new Log(LOG_FILE);
        manager.loadAll();
        if (manager.getAdminByUsername("admin") == null) {
            Administrator a = new Administrator("Default Admin", "admin", "admin", manager);
            manager.addAdmin(a);
        }
    }

    public static void main(String[] args) {
        RunGym app = new RunGym();
        app.mainMenu();
    }

    private void mainMenu() {
        while (true) {
            System.out.println("\n=== Gym Management ===");
            System.out.println("1) Register");
            System.out.println("2) Login");
            System.out.println("3) Exit");
            System.out.print("Select: ");
            String in = scanner.nextLine().trim();
            if (in.equalsIgnoreCase("3") || in.equalsIgnoreCase("EXIT")) {
                shutdown();
                break;
            }
            switch (in) {
                case "1": registerMenu(); break;
                case "2": loginMenu(); break;
                default: System.out.println("Invalid option."); break;
            }
        }
    }

    private void registerMenu() {
        System.out.println("\nRegister as:");
        System.out.println("1) Trainer");
        System.out.println("2) Member");
        System.out.print("Select: ");
        String choice = scanner.nextLine().trim();
        System.out.print("Name: "); String name = scanner.nextLine().trim();
        System.out.print("Username: "); String username = scanner.nextLine().trim();
        System.out.print("Password: "); String password = scanner.nextLine().trim();

        if (manager.usernameExists(username)) {
            System.out.println("Username already taken. Try again.");
            return;
        }
        if (choice.equals("1")) {
            System.out.print("Specialty: "); String spec = scanner.nextLine().trim();
            Trainer t = new Trainer(name, username, password, spec);
            manager.addTrainer(t);
            log.log(username, "Registered as Trainer");
            System.out.println("Trainer registered.");
        } else {
            Member m = new Member(name, username, password);
            manager.addMember(m);
            log.log(username, "Registered as Member");
            System.out.println("Member registered.");
        }
    }

    private void loginMenu() {
        System.out.print("Username: "); String username = scanner.nextLine().trim();
        System.out.print("Password: "); String password = scanner.nextLine().trim();

        Administrator a = manager.getAdminByUsername(username);
        if (a != null && a.getPassword().equals(password)) {
            log.log(username, "logged in as Admin");
            adminMenu(a);
            return;
        }
        Trainer t = manager.getTrainerByUsername(username);
        if (t != null && t.getPassword().equals(password)) {
            log.log(username, "logged in as Trainer");
            trainerMenu(t);
            return;
        }
        Member m = manager.getMemberByUsername(username);
        if (m != null && m.getPassword().equals(password)) {
            log.log(username, "logged in as Member");
            memberMenu(m);
            return;
        }
        System.out.println("Invalid credentials.");
    }

    /* Member menu and methods (managePlanFlow, enrollSessionFlow) */
    private void memberMenu(Member m) {
        while (true) {
            System.out.println("\nMember Menu - " + m.getUsername());
            System.out.println("1) Manage Plan");
            System.out.println("2) Enroll in a Session");
            System.out.println("3) Sign Out");
            System.out.print("Select: ");
            String c = scanner.nextLine().trim();
            switch (c) {
                case "1": managePlanFlow(m); break;
                case "2": enrollSessionFlow(m); break;
                case "3": log.log(m.getUsername(), "Signed out"); return;
                default: System.out.println("Invalid option."); break;
            }
        }
    }

    private void managePlanFlow(Member m) {
        System.out.println("\nAvailable Plans:");
        for (Plan p : manager.allPlans()) System.out.println(p);
        System.out.print("Enter plan name to choose (or BACK): ");
        String input = scanner.nextLine().trim();
        if (input.equalsIgnoreCase("BACK")) return;
        Plan plan = manager.getPlanByName(input);
        if (plan == null) { System.out.println("Plan not found."); return; }
        LocalDate start = LocalDate.now();
        LocalDate end = start.plusMonths(plan.getDurationMonths());
        m.setMembership(plan, start, end);
        log.log(m.getUsername(), "Changed membership to " + plan.getPlanName());
        System.out.println("Plan set: " + plan);
    }

    private void enrollSessionFlow(Member m) {
        System.out.println("\nAvailable Sessions:");
        for (Session s : manager.allSessions()) System.out.println(s);
        System.out.print("Enter sessionId to enroll (or BACK): ");
        String sid = scanner.nextLine().trim();
        if (sid.equalsIgnoreCase("BACK")) return;
        Session s = manager.getSessionById(sid);
        if (s == null) { System.out.println("Session not found."); return; }
        if (s.isFull()) {
            System.out.println("Session is full.");
            log.log(m.getUsername(), "Attempted to enroll in full session " + sid);
            return;
        }
        if (s.enrollMember(m.getUsername())) {
            m.enrollSession(sid);
            log.log(m.getUsername(), "Enrolled in session " + sid);
            System.out.println("Enrolled!");
        } else {
            System.out.println("Could not enroll (maybe already enrolled).");
        }
    }

    /* Trainer menu */
    private void trainerMenu(Trainer t) {
        while (true) {
            System.out.println("\nTrainer Menu - " + t.getUsername());
            System.out.println("1) View Sessions");
            System.out.println("2) View Members");
            System.out.println("3) Sign Out");
            System.out.print("Select: ");
            String c = scanner.nextLine().trim();
            switch (c) {
                case "1":
                    for (Session s : manager.allSessions())
                        if (s.getTrainerUsername().equals(t.getUsername())) System.out.println(s);
                    break;
                case "2":
                    System.out.println("Members enrolled in your sessions:");
                    for (Session s : manager.allSessions())
                        if (s.getTrainerUsername().equals(t.getUsername())) System.out.println(s);
                    break;
                case "3": log.log(t.getUsername(), "Signed out"); return;
                default: System.out.println("Invalid option."); break;
            }
        }
    }

    /* Admin menu and submenus */
    private void adminMenu(Administrator a) {
        while (true) {
            System.out.println("\nAdmin Menu - " + a.getUsername());
            System.out.println("1) Manage Members");
            System.out.println("2) Manage Trainers");
            System.out.println("3) Manage Workout Sessions");
            System.out.println("4) Manage Membership Plans");
            System.out.println("5) Sign Out");
            System.out.print("Select: ");
            String c = scanner.nextLine().trim();
            switch (c) {
                case "1": manageMembersMenu(); break;
                case "2": manageTrainersMenu(); break;
                case "3": manageSessionsMenu(); break;
                case "4": managePlansMenu(); break;
                case "5": log.log(a.getUsername(), "Signed out"); return;
                default: System.out.println("Invalid option."); break;
            }
        }
    }

    private void manageMembersMenu() {
        while (true) {
            System.out.println("\nManage Members");
            System.out.println("1) Add");
            System.out.println("2) View");
            System.out.println("3) Update");
            System.out.println("4) Delete");
            System.out.println("5) Back");
            System.out.print("Select: ");
            String c = scanner.nextLine().trim();
            switch (c) {
                case "1":
                    System.out.print("Name: "); String name = scanner.nextLine().trim();
                    System.out.print("Username: "); String username = scanner.nextLine().trim();
                    System.out.print("Password: "); String pass = scanner.nextLine().trim();
                    if (manager.usernameExists(username)) { System.out.println("Username exists."); break; }
                    manager.addMember(new Member(name, username, pass));
                    log.log(username, "Added by Admin");
                    System.out.println("Member added.");
                    break;
                case "2":
                    System.out.print("Enter ID, name, username or ALL: ");
                    String q = scanner.nextLine().trim();
                    if (q.equalsIgnoreCase("ALL")) for (Member m : manager.allMembers()) System.out.println(m);
                    else {
                        Member found = manager.getMemberByUsername(q);
                        if (found != null) System.out.println(found);
                        else System.out.println("Member not found.");
                    }
                    break;
                case "3":
                    System.out.print("Enter username to update: "); String uname = scanner.nextLine().trim();
                    Member old = manager.getMemberByUsername(uname);
                    if (old == null) { System.out.println("Not found."); break; }
                    System.out.println("1) Change name\n2) Change username\n3) Change password\n4) Change membership\nSelect: ");
                    String opt = scanner.nextLine().trim();
                    if (opt.equals("1")) { System.out.print("New name: "); old.setName(scanner.nextLine().trim()); }
                    else if (opt.equals("2")) { System.out.print("New username: "); String nu = scanner.nextLine().trim();
                        if (manager.usernameExists(nu)) System.out.println("Username taken."); else old.setUsername(nu);
                    } else if (opt.equals("3")) { System.out.print("New password: "); old.setPassword(scanner.nextLine().trim()); }
                    else if (opt.equals("4")) { System.out.print("Plan name: "); String pn = scanner.nextLine().trim();
                        Plan plan = manager.getPlanByName(pn); if (plan == null) System.out.println("Plan not found.");
                        else old.setMembership(plan, LocalDate.now(), LocalDate.now().plusMonths(plan.getDurationMonths()));
                    }
                    log.log(uname, "Updated by Admin"); System.out.println("Updated.");
                    break;
                case "4":
                    System.out.print("Enter username to delete: "); String del = scanner.nextLine().trim();
                    Member toDel = manager.getMemberByUsername(del);
                    if (toDel == null) { System.out.println("Not found."); break; }
                    System.out.print("Confirm delete (Y/N): ");
                    if (scanner.nextLine().trim().equalsIgnoreCase("Y")) {
                        manager.deleteMember(del); log.log(del, "Deleted by Admin"); System.out.println("Deleted.");
                    }
                    break;
                case "5": return;
                default: System.out.println("Invalid option."); break;
            }
        }
    }

    private void manageTrainersMenu() {
        while (true) {
            System.out.println("\nManage Trainers");
            System.out.println("1) Add");
            System.out.println("2) View");
            System.out.println("3) Update");
            System.out.println("4) Delete");
            System.out.println("5) Back");
            System.out.print("Select: ");
            String c = scanner.nextLine().trim();
            switch (c) {
                case "1":
                    System.out.print("Name: "); String name = scanner.nextLine().trim();
                    System.out.print("Username: "); String username = scanner.nextLine().trim();
                    System.out.print("Password: "); String pass = scanner.nextLine().trim();
                    System.out.print("Specialty: "); String spec = scanner.nextLine().trim();
                    if (manager.usernameExists(username)) { System.out.println("Username exists."); break; }
                    manager.addTrainer(new Trainer(name, username, pass, spec));
                    log.log(username, "Trainer added by Admin"); System.out.println("Trainer added.");
                    break;
                case "2":
                    System.out.print("Enter username or ALL: "); String q = scanner.nextLine().trim();
                    if (q.equalsIgnoreCase("ALL")) for (Trainer t : manager.allTrainers()) System.out.println(t);
                    else { Trainer t = manager.getTrainerByUsername(q); if (t == null) System.out.println("Not found."); else System.out.println(t); }
                    break;
                case "3":
                    System.out.print("Enter username to update: "); String uname = scanner.nextLine().trim();
                    Trainer tr = manager.getTrainerByUsername(uname); if (tr == null) { System.out.println("Not found."); break; }
                    System.out.print("New specialty: "); tr.setSpecialty(scanner.nextLine().trim()); System.out.println("Updated.");
                    log.log(uname, "Trainer updated by Admin"); break;
                case "4":
                    System.out.print("Enter username to delete: "); String del = scanner.nextLine().trim();
                    if (manager.getTrainerByUsername(del) == null) { System.out.println("Not found."); break; }
                    System.out.print("Confirm delete (Y/N): ");
                    if (scanner.nextLine().trim().equalsIgnoreCase("Y")) {
                        manager.allTrainers().removeIf(t -> t.getUsername().equals(del));
                        log.log(del, "Trainer deleted by Admin"); System.out.println("Deleted.");
                    }
                    break;
                case "5": return;
                default: System.out.println("Invalid option."); break;
            }
        }
    }

    private void manageSessionsMenu() {
        while (true) {
            System.out.println("\nManage Workout Sessions");
            System.out.println("1) Add");
            System.out.println("2) View");
            System.out.println("3) Update");
            System.out.println("4) Delete");
            System.out.println("5) Back");
            System.out.print("Select: ");
            String c = scanner.nextLine().trim();
            switch (c) {
                case "1":
                    System.out.print("Session name: "); String name = scanner.nextLine().trim();
                    System.out.print("Date (YYYY-MM-DD): "); String date = scanner.nextLine().trim();
                    System.out.print("Time (HH:MM:SS): "); String time = scanner.nextLine().trim();
                    System.out.print("Capacity: "); int cap = Integer.parseInt(scanner.nextLine().trim());
                    System.out.print("Trainer username: "); String trainer = scanner.nextLine().trim();
                    if (manager.getTrainerByUsername(trainer) == null) System.out.println("Trainer not found.");
                    else {
                        Session s = new Session(name, LocalDate.parse(date), LocalTime.parse(time), cap, trainer);
                        manager.addSession(s); log.log("admin", "Added session " + s.getSessionId()); System.out.println("Session added: " + s.getSessionId());
                    }
                    break;
                case "2":
                    System.out.print("Enter sessionId, name, date or ALL: "); String q = scanner.nextLine().trim();
                    if (q.equalsIgnoreCase("ALL")) for (Session s : manager.allSessions()) System.out.println(s);
                    else {
                        Session s = manager.getSessionById(q);
                        if (s != null) System.out.println(s);
                        else {
                            boolean found = false;
                            for (Session ss : manager.allSessions()) {
                                if (ss.getName().equalsIgnoreCase(q) || ss.getDate().toString().equals(q)) { System.out.println(ss); found = true; }
                            }
                            if (!found) System.out.println("No sessions found.");
                        }
                    }
                    break;
                case "3":
                    System.out.print("Enter sessionId to update: "); String sid = scanner.nextLine().trim();
                    Session s = manager.getSessionById(sid);
                    if (s == null) { System.out.println("Not found."); break; }
                    System.out.print("New date (YYYY-MM-DD or ENTER to skip): "); String nd = scanner.nextLine().trim();
                    if (!nd.isEmpty()) s = updateSessionDate(s, nd);
                    System.out.print("New time (HH:MM:SS or ENTER to skip): "); String nt = scanner.nextLine().trim();
                    if (!nt.isEmpty()) s = updateSessionTime(s, nt);
                    System.out.print("New trainer username (or ENTER): "); String ntu = scanner.nextLine().trim();
                    if (!ntu.isEmpty()) s = updateSessionTrainer(s, ntu);
                    log.log("admin", "Updated session " + sid); System.out.println("Updated.");
                    break;
                case "4":
                    System.out.print("Enter sessionId to delete: "); String del = scanner.nextLine().trim();
                    if (manager.getSessionById(del) == null) { System.out.println("Not found."); break; }
                    System.out.print("Confirm delete (Y/N): ");
                    if (scanner.nextLine().trim().equalsIgnoreCase("Y")) {
                        manager.allSessions().removeIf(ss -> ss.getSessionId().equals(del)); log.log("admin", "Deleted session " + del); System.out.println("Deleted.");
                    }
                    break;
                case "5": return;
                default: System.out.println("Invalid option."); break;
            }
        }
    }

    private Session updateSessionDate(Session s, String nd) {
        try { return new Session(s.getName(), LocalDate.parse(nd), s.getTime(), s.getCapacity(), s.getTrainerUsername()); }
        catch (Exception ex) { System.out.println("Invalid date format."); return s; }
    }

    private Session updateSessionTime(Session s, String nt) {
        try { return new Session(s.getName(), s.getDate(), LocalTime.parse(nt), s.getCapacity(), s.getTrainerUsername()); }
        catch (Exception ex) { System.out.println("Invalid time format."); return s; }
    }

    private Session updateSessionTrainer(Session s, String ntu) {
        if (manager.getTrainerByUsername(ntu) == null) { System.out.println("Trainer not found."); return s; }
        return new Session(s.getName(), s.getDate(), s.getTime(), s.getCapacity(), ntu);
    }

    private void managePlansMenu() {
        while (true) {
            System.out.println("\nManage Plans");
            System.out.println("1) Add");
            System.out.println("2) View");
            System.out.println("3) Update");
            System.out.println("4) Delete");
            System.out.println("5) Back");
            System.out.print("Select: ");
            String c = scanner.nextLine().trim();
            switch (c) {
                case "1":
                    System.out.print("Plan name: "); String name = scanner.nextLine().trim();
                    System.out.print("Duration months: "); int months = Integer.parseInt(scanner.nextLine().trim());
                    System.out.print("Price: "); double price = Double.parseDouble(scanner.nextLine().trim());
                    manager.addPlan(new Plan(name, months, price)); log.log("admin", "Added plan " + name); System.out.println("Plan added.");
                    break;
                case "2": for (Plan p : manager.allPlans()) System.out.println(p); log.log("admin", "Viewed plans"); break;
                case "3":
                    System.out.print("Enter plan name to update: "); String pn = scanner.nextLine().trim();
                    Plan p = manager.getPlanByName(pn); if (p == null) { System.out.println("Plan not found."); break; }
                    System.out.print("New duration or ENTER: "); String nmonths = scanner.nextLine().trim();
                    if (!nmonths.isEmpty()) p.setDurationMonths(Integer.parseInt(nmonths));
                    System.out.print("New price or ENTER: "); String nprice = scanner.nextLine().trim();
                    if (!nprice.isEmpty()) p.setPrice(Double.parseDouble(nprice));
                    log.log("admin", "Updated plan " + pn); System.out.println("Updated."); break;
                case "4":
                    System.out.print("Enter plan name to delete: "); String del = scanner.nextLine().trim();
                    if (manager.getPlanByName(del) == null) { System.out.println("Not found."); break; }
                    System.out.print("Confirm delete (Y/N): ");
                    if (scanner.nextLine().trim().equalsIgnoreCase("Y")) {
                        manager.allPlans().removeIf(pl -> pl.getPlanName().equals(del)); log.log("admin", "Deleted plan " + del); System.out.println("Deleted.");
                    }
                    break;
                case "5": return;
                default: System.out.println("Invalid option."); break;
            }
        }
    }

    private void shutdown() {
        System.out.println("Saving data...");
        manager.saveAll();
        log.log("SYSTEM", "Shutdown and saved data");
        System.out.println("Goodbye.");
    }
}
